# ============================================
# Caddy 配置 - POSX Demo 环境
# ============================================
# 
# 特性：
# - 自动 HTTPS（Let's Encrypt）
# - CORS 正则匹配多域名
# - Gzip 压缩
# - JSON 日志
# - 反向代理到 Django
# 
# ⚠️ 注意：
# - DNS 必须正确解析到服务器 IP
# - 端口 80/443 必须开放
# - Cloudflare 使用灰色云朵（关闭代理）
# 
# ============================================

{
	# 邮箱用于 Let's Encrypt 通知
	email ops@posx.io
	
	# 全局日志
	log {
		output stdout
		format json
		level INFO
	}
}

# ============================================
# Demo API 域名配置
# ============================================
demo-api.posx.io {
	# Gzip 压缩
	encode gzip
	
	# ============================================
	# CORS 配置（正则匹配多域名）⭐
	# ============================================
	# 允许的域名：
	# - https://posx.retool.com
	# - https://adminhq.posx.io
	
	@allow_origin {
		header_regexp origin Origin ^https://(posx\.retool\.com|adminhq\.posx\.io)$
	}
	
	# 为匹配的请求设置 CORS 头
	header @allow_origin {
		Access-Control-Allow-Origin "{http.request.header.Origin}"
		Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Authorization, Content-Type, X-Site-Code"
		Access-Control-Allow-Credentials "true"
		Access-Control-Max-Age "3600"
	}
	
	# OPTIONS 预检请求
	@preflight {
		method OPTIONS
	}
	respond @preflight 204
	
	# ============================================
	# 反向代理到 Django
	# ============================================
	reverse_proxy web:8000 {
		# 健康检查
		health_uri /ready/
		health_interval 30s
		health_timeout 10s
		
		# 转发真实客户端信息
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
	}
	
	# ============================================
	# 访问日志
	# ============================================
	log {
		output stdout
		format json
		level INFO
	}
}

